# =============================================================================
# Google Cloud Build configuration for Cloud Run deployment
# =============================================================================
#
# This file defines the CI/CD pipeline for deploying to Cloud Run.
#
# Prerequisites:
#   1. Enable Cloud Build API: gcloud services enable cloudbuild.googleapis.com
#   2. Enable Cloud Run API: gcloud services enable run.googleapis.com
#   3. Enable Artifact Registry API: gcloud services enable artifactregistry.googleapis.com
#   4. Create Artifact Registry repository:
#      gcloud artifacts repositories create genmedia --repository-format=docker --location=us-central1
#   5. Grant Cloud Build permission to deploy to Cloud Run:
#      gcloud projects add-iam-policy-binding PROJECT_ID \
#        --member="serviceAccount:PROJECT_NUMBER@cloudbuild.gserviceaccount.com" \
#        --role="roles/run.admin"
#      gcloud iam service-accounts add-iam-policy-binding \
#        PROJECT_NUMBER-compute@developer.gserviceaccount.com \
#        --member="serviceAccount:PROJECT_NUMBER@cloudbuild.gserviceaccount.com" \
#        --role="roles/iam.serviceAccountUser"
#
# Trigger options:
#   - Manual: gcloud builds submit --config cloudbuild.yaml
#   - GitHub trigger: Connect repo in Cloud Build console
#
# =============================================================================

substitutions:
  _REGION: us-central1
  _SERVICE_NAME: genmedia-frontend
  _REPOSITORY: genmedia
  _IMAGE_TAG: latest
  _REQUIRE_AUTH: 'true'
  _VITE_FIREBASE_API_KEY: ''
  _VITE_FIREBASE_AUTH_DOMAIN: ''
  _VITE_FIREBASE_PROJECT_ID: ''
  _VITE_FIREBASE_STORAGE_BUCKET: ''
  _VITE_FIREBASE_MESSAGING_SENDER_ID: ''
  _VITE_FIREBASE_APP_ID: ''
  _VITE_FIREBASE_MEASUREMENT_ID: ''

steps:
  # Step 1: Build the Docker image
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build'
    args:
      - 'build'
      - '-t'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_NAME}:${_IMAGE_TAG}'
      - '-t'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_NAME}:latest'
      - '--build-arg'
      - 'VITE_FIREBASE_API_KEY=${_VITE_FIREBASE_API_KEY}'
      - '--build-arg'
      - 'VITE_FIREBASE_AUTH_DOMAIN=${_VITE_FIREBASE_AUTH_DOMAIN}'
      - '--build-arg'
      - 'VITE_FIREBASE_PROJECT_ID=${_VITE_FIREBASE_PROJECT_ID}'
      - '--build-arg'
      - 'VITE_FIREBASE_STORAGE_BUCKET=${_VITE_FIREBASE_STORAGE_BUCKET}'
      - '--build-arg'
      - 'VITE_FIREBASE_MESSAGING_SENDER_ID=${_VITE_FIREBASE_MESSAGING_SENDER_ID}'
      - '--build-arg'
      - 'VITE_FIREBASE_APP_ID=${_VITE_FIREBASE_APP_ID}'
      - '--build-arg'
      - 'VITE_FIREBASE_MEASUREMENT_ID=${_VITE_FIREBASE_MEASUREMENT_ID}'
      - '.'

  # Step 2: Push to Artifact Registry
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push'
    args:
      - 'push'
      - '--all-tags'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_NAME}'

  # Step 3: Deploy to Cloud Run
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy'
    entrypoint: 'gcloud'
    args:
      - 'run'
      - 'deploy'
      - '${_SERVICE_NAME}'
      - '--image'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_NAME}:${_IMAGE_TAG}'
      - '--region'
      - '${_REGION}'
      - '--platform'
      - 'managed'
      - '--allow-unauthenticated'
      - '--memory'
      - '512Mi'
      - '--cpu'
      - '1'
      - '--min-instances'
      - '0'
      - '--max-instances'
      - '10'
      - '--set-env-vars'
      - 'NODE_ENV=production,REQUIRE_AUTH=${_REQUIRE_AUTH},GCP_PROJECT_ID=${PROJECT_ID}'

# Store images in Artifact Registry
images:
  - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_NAME}:${_IMAGE_TAG}'
  - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_NAME}:latest'

# Build options
options:
  logging: CLOUD_LOGGING_ONLY
  machineType: 'E2_HIGHCPU_8'

# Timeout for the entire build (15 minutes)
timeout: '900s'
